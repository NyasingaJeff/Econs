function zbscrm_JS_retrieve_invoice_data(i){var e={action:"zbs_get_invoice_data",sec:window.zbscrmjs_secToken,invid:i};jQuery.ajax({type:"POST",url:ajaxurl,data:e,dataType:"json",timeout:2e4,success:function(i){void 0!==i&&(window.zbs_invoice=i),void 0!==i.tax_linesObj&&(window.zbs_tax_table=i.tax_linesObj),void 0!==i.invoiceObj&&void 0!==i.invoiceObj.settings&&void 0!==i.invoiceObj.settings.invtax&&(window.zbs_tax=i.invoiceObj.settings.invtax),zbscrm_JS_draw_invoice_html()},error:function(i){jQuery("#zbsCantLoadDataSingle").show(),jQuery("#zbs-edit-wrap, #zbs-screen-options").hide(),jQuery("#zbs_loader, #zbs_invoice").hide()}})}function zbscrm_JS_draw_invoice_html(){if(void 0!==window.zbs_invoice&&!1!==window.zbs_invoice){jQuery("#zbsCantLoadDataSingle").hide(),jQuery("#zbs-edit-wrap, #zbs-screen-options").show(),jQuery("#zbs_loader, #zbs_invoice").show();var i="";i=zbscrm_JS_draw_invoice_actions_html(window.zbs_invoice),i+='<div id="zbs_top_wrapper">',i+=zbscrm_JS_draw_invoice_logo_html(window.zbs_invoice),i+=zbscrm_JS_draw_invoice_top_right_form(window.zbs_invoice),i+="</div>",i+='<div style="clear:both">&nbsp;</div><div id="zbs_sub_wrapper" class="ui grid">',i+='<div class="six wide column">',i+=zbscrm_JS_draw_invoice_biz_info(window.zbs_invoice),i+="</div>",i+='<div class="ten wide column">',i+=zbscrm_JS_draw_send_invoice_to(window.zbs_invoice),i+="</div>",i+="</div>",i+=zbscrm_JS_draw_customise(window.zbs_invoice),i+=zbscrm_JS_draw_line_items(window.zbs_invoice),i+=zbscrm_JS_draw_invoice_totals(window.zbs_invoice),i+=zbscrm_JS_draw_partials_table(window.zbs_invoice),jQuery(".zbs_invoice_html_canvas").html(i),setTimeout(function(){jQuery("#zbs-invoice-custom-fields-holder table tr").appendTo(".zbs-invoice-topper table"),zbscrm_JS_bind_row_actions(),zbscrm_JS_bind_change_actions(),zbscrm_JS_bind_invoice_actions(),jQuery("#zbs_loader").hide()},0)}else jQuery("#zbsCantLoadDataSingle").show(),jQuery("#zbs-edit-wrap, #zbs-screen-options").hide(),jQuery("#zbs_loader, #zbs_invoice").hide()}function zbscrm_JS_draw_invoice_actions_html(i){if(html="",html+='<div id="zbs_invoice_actions">',html+='<div class="zbs-invoice-status">',html+='<span class="'+i.invoiceObj.status+' statty">'+i.invoiceObj.status+"</span>",html+="</div>",!i.invoiceObj.new_invoice&&(i.invoiceObj.portal_installed&&(html+='<a href="'+i.invoiceObj.preview_link+'" target="_blank" class="ui button blue" id="zbs_invoice_preview">'+zbscrm_JS_invoice_lang("preview")+"</a>"),i.invoiceObj.pdf_installed&&(html+='<button id="zbs_invoicing_download_pdf" type="button" class="ui button olive">'+zbscrm_JS_invoice_lang("dl_pdf")+"</button>",Formhtml='<form target="_blank" method="post" id="zbs_invoicing_download_pdf_form" action="">',Formhtml+='<input type="hidden" name="zbs_invoicing_download_pdf" value="1" />',Formhtml+='<input type="hidden" name="zbs_invoice_id" value="'+i.invoiceObj.id+'" />',Formhtml+="</form>",jQuery("#wpbody").append(Formhtml)),void 0!==window.zbsJS_invEmailActive&&1==window.zbsJS_invEmailActive)){var e=zbscrmJS_retrieveCurrentBillToEmail();void 0!==e&&""!=e&&zbscrm_JS_validateEmail(e)&&(html+='<button type="button" id="zbs_invoicing_send_email" class="ui button yellow">'+zbscrm_JS_invoice_lang("send_email")+"</button>")}return i.invoiceObj.new_invoice&&(html+='<input type="hidden" name="zbscrm_newinvoice" value="1" />'),html+="</div>",html}function zbscrmJS_retrieveCurrentBillToEmail(){var i=jQuery("#zbs_inv_bill").val();if(void 0===i){var e=window.zbs_invoice.invoiceObj.bill;null!=e&&""!=e||void 0===window.zbsJS_prefillemail||void 0===window.zbsJS_prefillid||(e=window.zbsJS_prefillemail),i=e}return i}function zbscrm_JS_draw_invoice_logo_html(i){var e="",t="",o="";return""!=i.invoiceObj.logo_url&&(t="hide",o="show"),e='<div id="zbs_invoice_logos">',e+='<div class="wh-logo '+t+'">',e+='<i class="fa fa-file-image-o" aria-hidden="true"></i><span class="wh-logo-text">+ '+zbscrm_JS_invoice_lang("add_logo")+"</span>",e+="</div>",e+='<div class="wh-logo-set '+o+'">',e+='<img id="wh-logo-set-img" src="'+i.invoiceObj.logo_url+'" />',e+='<input type="hidden" name="zbsi_logo" id="logo" value="'+i.invoiceObj.logo_url+'" />',e+='<div class="zbs-logo-options">',e+='<span class="zbs-update">'+zbscrm_JS_invoice_lang("update")+"</span>",e+='<span class="zbs-remove"> '+zbscrm_JS_invoice_lang("remove")+"</span>",e+="</div>",e+="</div>",e+="</div>"}function zbscrm_JS_draw_invoice_top_right_form(i){if(html="",html+='<div class="zbs-invoice-topper">',html+='<table class="form-table">',"1"!=i.invoiceObj.settings.hideid){var e="",t=-1;void 0!==i.invoiceObj.id&&(e=i.invoiceObj.id,t=i.invoiceObj.id),-1==e?(html+='<tr class="hide"><th></th><td>',html+='<input type="hidden" name="zbsinvid" value="'+t+'" />',html+="</td></tr>"):(html+='<tr class="wh-large zbs-invoice-number"><th><label for="no">'+zbscrm_JS_invoice_lang("invoice_number")+":</label></th>",html+="<td>",html+='<span class="zbs-inv-no">'+e+"</span>",html+='<input type="hidden" name="zbsinvid" value="'+t+'" />',html+="</td>",html+="</tr>")}return html+='<tr class="wh-large"><th><label for="date">'+zbscrm_JS_invoice_lang("invoice_date")+":</label></th>",html+="<td>",html+='<input type="text" name="zbsi_date" id="date" class="form-control zbs-date zbs-empty-start" placeholder="" value="'+i.invoiceObj.date_date+'" data-original-date="'+i.invoiceObj.date_date+'" data-utc="'+i.invoiceObj.date+'" />',html+="</td>",html+="</tr>",html+='<tr class="wh-large">',html+='<th><label for="ref">'+zbscrm_JS_invoice_lang("reference")+":</label></th>",html+="<td>",html+='<input type="text" name="zbsi_ref" id="ref" class="form-control widetext" placeholder="" value="'+i.invoiceObj.id_override+'" autocomplete="zbsinv" />',html+="</td>",html+="</tr>",void 0!==i.invoiceObj.due_date&&null!=i.invoiceObj.due_date&&0!=i.invoiceObj.due_date?(html+='<tr class="wh-large"><th><label for="due_date">'+zbscrm_JS_invoice_lang("due_date")+":</label></th>",html+="<td>",html+='<input type="text" name="zbsi_due_date" id="due_date" class="form-control zbs-date" placeholder="" value="'+i.invoiceObj.due_date_date+'" data-original-date="'+i.invoiceObj.due_date_date+'" />',html+="</td>",html+="</tr>"):(html+='<tr class="wh-large">',html+='<th><label for="due">'+zbscrm_JS_invoice_lang("due_date")+":</label></th>",html+="<td>",html+='<select id="zbsinv_due_days" name="zbsi_due" class="form-control" style="font-size:16px;">',html+='<option value = "-1">'+zbscrm_JS_invoice_lang("due","","none")+"</option>",html+='<option value = "0">'+zbscrm_JS_invoice_lang("due","","on")+"</option>",html+='<option value = "10">'+zbscrm_JS_invoice_lang("due","","ten")+"</option>",html+='<option value = "15">'+zbscrm_JS_invoice_lang("due","","fifteen")+"</option>",html+='<option value = "30">'+zbscrm_JS_invoice_lang("due","","thirty")+"</option>",html+='<option value = "45">'+zbscrm_JS_invoice_lang("due","","fortyfive")+"</option>",html+='<option value = "60">'+zbscrm_JS_invoice_lang("due","","sixty")+"</option>",html+='<option value = "90">'+zbscrm_JS_invoice_lang("due","","ninety")+"</option>",html+="</select>",html+="</td>",html+="</tr>"),"function"==typeof window.zbscrm_JS_draw_invoice_pro_top_right&&(html+=zbscrm_JS_draw_invoice_pro_top_right(i.invoiceObj)),void 0!==window.zbscrmjs_invoice_custom_fields&&window.zbscrmjs_invoice_custom_fields.length,html+="</table></div>",html+='<div class="clear"></div>',html}function zbscrm_JS_draw_send_invoice_to(i){var e=i.invoiceObj.invoice_contact,t=i.invoiceObj.invoice_company;"object"==typeof zbs_invoice.invoiceObj.invoice_contact&&void 0!==zbs_invoice.invoiceObj.invoice_contact.id&&(e=parseInt(zbs_invoice.invoiceObj.invoice_contact.id)),"object"==typeof zbs_invoice.invoiceObj.invoice_company&&void 0!==zbs_invoice.invoiceObj.invoice_company.id&&(t=parseInt(zbs_invoice.invoiceObj.invoice_company.id));var o=i.invoiceObj.bill;null!=o&&""!=o||void 0===window.zbsJS_prefillemail||void 0===window.zbsJS_prefillid||(o=window.zbsJS_prefillemail,void 0!==window.zbsJS_prefillobjtype&&(1==window.zbsJS_prefillobjtype&&-1==e&&(e=parseInt(window.zbsJS_prefillid)),2==window.zbsJS_prefillobjtype&&-1==t&&(t=parseInt(window.zbsJS_prefillid)),e<=0&&(e=-1),t<=0&&(t=-1)));var n="";return n+='<div id="billing-to">',n+='<div class="billing-to-title">',n+='<i class="linkify icon"></i> <span class="your-info-biz">'+zbscrm_JS_invoice_lang("send_to")+"</span>",n+="</div>",n+='<div class="form-table">',n+='<div class="wh-large inv-to-input">',n+='<div class="zbs-type-ahead-invoice">',n+='<input class="form-control typeahead" type="email" id="zbs_inv_bill" name="zbscq_bill" value="'+o+'" placeholder="'+zbscrm_JS_invoice_lang("bill_to")+'" />',n+="</div>",n+='<div class="edit-c"><a class="zbs-edit-assign-to" href="#">'+zbscrm_JS_invoice_lang("edit_record")+"</a></div>",n+="</div>",n+="</div>",n+="</div>",n+='<div class="clear"></div>',n+='<input type="hidden" id="zbs_invoice_contact" name="zbs_invoice_contact" value="'+e+'" />',n+='<input type="hidden" id="zbs_invoice_company" name="zbs_invoice_company" value="'+t+'" />'}function zbscrm_JS_draw_customise(i){return html="",html+='<div id="zbs-invoice-customiser">',html+='<div class="ui grid" style="margin: 0em 0.5em;">',html+='<div class="eight wide column" style="padding:0">',html+='<span class="header" style="float:left;">'+zbscrm_JS_invoice_lang("customise")+"</span>",html+='<select class="form-control" id="invoice-customiser-type" name="invoice-customiser-type" id="invoice-customiser-type" style="width:30%;">',html+='<option value="quantity"',"quantity"==i.invoiceObj.invoice_hours_or_quantity&&(html+=' selected="selected"'),html+=">"+zbscrm_JS_invoice_lang("quantity")+"</option>",html+='<option value="hours"',"hours"==i.invoiceObj.invoice_hours_or_quantity&&(html+=' selected="selected"'),html+=">"+zbscrm_JS_invoice_lang("hours")+"</option>",html+="</select>",html+="</div>",html+='<div class="eight wide column" style="padding:0">',"function"==typeof window.zbscrm_JS_draw_invoiceCustomiserExtras&&(html+=zbscrm_JS_draw_invoiceCustomiserExtras(i)),html+="</div>",html+="</div>",html+="</div>",html+='<div class="clear"></div>',html}function zbscrm_JS_draw_invoice_biz_info(i){return html="",html+='<div id="zbs-business-info-wrapper">',html+='<div class="business-info-toggle">',html+='<i class="fa fa-chevron-circle-right" aria-hidden="true"></i> <span class="your-info-biz">'+zbscrm_JS_invoice_lang("biz_info")+"</span>",html+="</div>",html+='<div class="business-info">',html+='<table class="table zbs-table">',html+="<tbody>",html+="<tr><td>"+i.invoiceObj.settings.bizname+"</td></tr>",html+="<tr><td>"+i.invoiceObj.settings.yourname+"</td></tr>",html+="<tr><td>"+i.invoiceObj.settings.businessextra+"</td></tr>",html+='<tr class="top-pad"><td>'+i.invoiceObj.settings.businessyouremail+"</td></tr>",html+="<tr><td>"+i.invoiceObj.settings.businessyoururl+"</td></tr>",html+="</tbody>",html+="</table>",html+='<span class="edit-or-add"><a href="'+i.invoiceObj.settings.biz_settings_slug+'" target="_blank">'+zbscrm_JS_invoice_lang("add_edit")+"</a></span>",html+="</div>",html+="</div>",html}function zbscrm_JS_draw_line_items(e){window.zbs_invoice_rownum=1;var t="";if(t+='<div id="zbs-invoice-items">',t+='<table class="table">',t+="<thead>",t+="<th>"+zbscrm_JS_invoice_lang("description")+"</th>","quantity"==e.invoiceObj.invoice_hours_or_quantity?(t+='<th class="cen" id="zbs_inv_qoh">'+zbscrm_JS_invoice_lang("quantity")+"</th>",t+='<th class="cen" id = "zbs_inv_por" >'+zbscrm_JS_invoice_lang("price")+"</th>"):(t+='<th class="cen" id="zbs_inv_qoh">'+zbscrm_JS_invoice_lang("hours")+"</th>",t+='<th class="cen" id="zbs_inv_por">'+zbscrm_JS_invoice_lang("rate")+"</th>"),1==e.invoiceObj.settings.invtax&&(t+='<th class="cen taxhide">'+zbscrm_JS_invoice_lang("tax")+"</th>"),t+="<th>"+zbscrm_JS_invoice_lang("amount")+"</th>",t+="</thead>",t+='<tbody class="zbs-invoice-line-items">',rowhtml="",""==e.invoiceObj.invoice_items){i=1;var o={};o.title="",o.desc="",o.quantity=1,o.price=0,o.rate=0,rowhtml+=zbscrm_JS_generate_invoice_row(e,i,o)}else jQuery.each(e.invoiceObj.invoice_items,function(i,t){rowhtml+=zbscrm_JS_generate_invoice_row(e,window.zbs_invoice_rownum,t)});return t+=rowhtml,t+="</tbody>",t+="</table>",t+='<div id="zbs-add-new-row"><i class="plus circle icon"></i>'+zbscrm_JS_invoice_lang("add_row")+"</div>",t+="</div>"}function zbscrm_JS_draw_invoice_totals(i){var e="";return e+='<div class="invoice-grand-total-wrapper ui grid">',e+='<div class="col-md-6 eight wide column"></div>',e+='<div class="col-md-6 inv-totals eight wide column">',e+='<div class="total-row">',e+='<div class="zlabel half">'+zbscrm_JS_invoice_lang("sub_total")+"</div>",e+='<div class="calc-value half ri" id="subtotal-value"></div>',e+="</div>",1==i.invoiceObj.settings.invdis&&(e+='<div class="total-row">',e+='<div class="zlabel one-four">'+zbscrm_JS_invoice_lang("discount")+"</div>",e+="<div class='two-four invoice-discount-total'>",e+='<input class = "form-control half" type="number" name="invoice_discount_total" id="invoice_discount_total" step="0.01" min="0" value="'+i.invoiceObj.totals.invoice_discount_total+'">',"m"==i.invoiceObj.totals.invoice_discount_type?e+='<select id="invoice_discount_type" name="invoice_discount_type" class="form-control half"><option value="%" >%</option><option value="m" selected>'+zbscrm_JS_invoice_lang("amount")+"</option></select>":e+='<select id="invoice_discount_type" name="invoice_discount_type" class="form-control half"><option value="%">%</option><option value="m">'+zbscrm_JS_invoice_lang("amount")+"</option></select>",e+="</div>",e+='<div id="discount-value" class = "one-four ri">0</div>',e+="</div>"),1==i.invoiceObj.settings.invpandp&&(e+='<div class="total-row pbot30">',e+='<div class="zlabel half">'+zbscrm_JS_invoice_lang("shipping")+"</div>",e+='<input class="zbs_gt zbsli_price-1 half ri topmm5" type="number" step="0.01" min="0" name="invoice_postage_total" id="invoice_postage_total" value="'+i.invoiceObj.totals.invoice_postage_total+'">',e+="</div>"),shipping=i.invoiceObj.totals,shipping.taxes=i.invoiceObj.shipping_taxes,1==i.invoiceObj.settings.invpandp&&1==i.invoiceObj.settings.invtax&&(e+='<div class="total-row pbot30">',e+='<div class="zlabel half">'+zbscrm_JS_invoice_lang("tax_on_shipping")+"</div>",e+='<div class="half ri topmm10">'+zbscrm_JS_output_tax_line(i,-1,shipping)+"</div>",e+="</div>"),e+='<div class="total-row-wrap" id="tax-total-block">',e+="</div>",e+='<div class="total-row grand-total">',e+='<div class="zlabel half">'+zbscrm_JS_invoice_lang("total")+"</div>",e+='<div class="calc-value half ri zbs-heavy" id="zbs-inv-grand-total"></div>',e+='<input type="hidden" name="zbs-inv-grand-total-store" id="zbs-inv-grand-total-store" value="0" />',e+="</div>",e+="</div>",e+="</div>"}function zbscrm_JS_draw_partials_table(i){var e='<div id="zbs-invoice-partial-payments" class = "ui grid">';e+='<div class="col-md-6 eight wide column"></div>';return e+='<div class="col-md-6 eight wide column">',window.invoice_partial=!1,jQuery.each(i.invoiceObj.partials,function(i,t){var o="";0==i&&(e+='<div class="partial-row-tab">'+zbscrm_JS_invoice_lang("partial_table")+"</div>"),e+='<div class="partial-row">';var n="",a="";void 0!==t.type&&void 0!==t.type_accounting&&"credit"==t.type_accounting&&(n=" ("+t.type+")");var s="",c="";void 0!==t.type_accounting&&"credit"==t.type_accounting&&(s="(",c=")"),o=s+t.total+c;var l=zbscrm_JS_invoice_lang("incomplete","Incomplete");void 0!==t.status&&(l=t.status),void 0!==t.status_bool&&1!=t.status_bool&&(a+="<br />("+o+" - "+l+")",o="0.0");var r=zbscrm_JS_transaction_edit_URL(t.id);e+='<div class="zlabel half"><a href="'+r+'" target="_blank">'+t.ref+n+"</a>"+a+"</div>",e+='<div class="zbs-partial-value half ri">'+parseFloat(o).toFixed(zbs_root.currencyOptions.noOfDecimals)+"</div>",e+="</div>",window.invoice_partial=!0}),window.invoice_partial&&(e+='<div id="amount-due" class="due-row">',e+='<div class="amt-due-label zlabel half">'+zbscrm_JS_invoice_lang("amount_due")+"</div>",e+='<div class="amt-due-amt half ri" id="inv-amount-due"></div>',e+="</div>"),e+="</div>",e+="</div>"}function zbscrm_JS_generate_invoice_row(i,e,t){var o='<tr class="zbs-invoice-row zbs-item-block zbs-rowid'+e+'" data-rowid="'+e+'">';return null==t.title?item_title="":item_title=t.title,null==t.desc?item_description="":item_description=t.desc,o+='<td class="first">',o+='<input class="form-control zbs-item-name" type="text" name = "zbsli_itemname[]" value = "'+item_title+'" placeholder="'+zbscrm_JS_invoice_lang("rowtitleplaceholder")+'" /><br/>',o+='<textarea class="form-control" name = "zbsli_itemdes[]" placeholder="'+zbscrm_JS_invoice_lang("rowdescplaceholder")+'">'+item_description+"</textarea>",o+="</td>",o+='<td class="second">',o+='<input type="number" class="zbsli_quan zbsli_quan'+e+' form-control quan" data-zbsr="'+e+'" name = "zbsli_quan[]" value = "'+t.quantity+'" min="0">',o+="</td>",o+='<td class="third">',o+='<input type="number" class="zbsli_price zbsli_price'+e+' form-controm price" data-zbsr="'+e+'" name = "zbsli_price[]" value = "'+t.price+'" step="0.01">',o+="</td>",1==i.invoiceObj.settings.invtax&&(o+='<td class="forth">',o+=zbscrm_JS_output_tax_line(i,e,t),o+="</td>"),o+='<td class="fifth row-amount row-amount-'+e+'">',o+="</td>",o+='<td><div class="remove-row" data-rowid="'+e+'"><i class="times circle icon"></i></div></td>',o+="</tr>",window.zbs_invoice_rownum++,o}function zbscrm_JS_output_tax_line(i,e,t){var o;return o=void 0===t.taxes||null==t.taxes?0:parseInt(t.taxes),taxhtml=-1==e?'<select name="zbsli_tax_ship" class="tax-select tax-select'+e+' form-control" data-zbsr="'+e+'">':'<select name="zbsli_tax[]" class="tax-select tax-select'+e+' form-control" data-zbsr="'+e+'">',selected="",0==o&&(selected="selected"),taxhtml+='<option value="0" '+selected+">"+zbscrm_JS_invoice_lang("no_tax")+'</option><optgroup label="'+zbscrm_JS_invoice_lang("taxgrouplabel")+'">',jQuery.each(i.tax_linesObj,function(i,e){o==e.id?selected="selected":selected="",taxhtml+='<option value="'+e.id+'" '+selected+">"+e.name+" : "+e.rate+"%</option>"}),taxhtml+="</optgroup>",taxhtml+="</select>",taxhtml}function zbscrm_JS_add_empty_row(){var i="",e={};e.title="",e.desc="",e.quantity=1,e.price=0,e.rate=0,i+=zbscrm_JS_generate_invoice_row(window.zbs_invoice,window.zbs_invoice_rownum,e),jQuery(".zbs-invoice-line-items").append(i),zbscrm_JS_bind_row_actions()}function zbscrm_JS_bind_due_days(){void 0!==window.zbs_invoice&&void 0!==window.zbs_invoice.invoiceObj&&void 0!==window.zbs_invoice.invoiceObj.due&&jQuery("#zbsinv_due_days").val(window.zbs_invoice.invoiceObj.due)}function zbscrm_JS_bind_row_actions(){jQuery("#zbs-add-new-row").off("click").on("click",function(){zbscrm_JS_add_empty_row(window.zbs_invoice)}),jQuery(".remove-row").off("click").on("click",function(i){var e=jQuery(this).data("rowid");jQuery(".zbs-rowid"+e).remove(),setTimeout(function(){0==jQuery(".zbs-invoice-row").length&&zbscrm_JS_add_empty_row(window.zbs_invoice)},0),zbscrm_JS_calcTotals()}),jQuery(".zbs-item-block input[type=number]").on("keyup mouseup",function(){var i=jQuery(this).data("zbsr");jQuery(this).hasClass("quan")&&(quan=jQuery(this).val()),jQuery(this).hasClass("price")&&(price=jQuery(this).val()),jQuery(this).parent().siblings().find("input[type=number]").each(function(i,e){jQuery(e).hasClass("quan")&&(quan=e.value),jQuery(e).hasClass("price")&&(price=e.value)}),row_tot=quan*price,jQuery(this).parent().siblings(".row-amount-"+i).html(row_tot.toFixed(zbs_root.currencyOptions.noOfDecimals)),zbscrm_JS_calcTotals()}),jQuery(".tax-select").on("change",function(){jQuery(this).val();zbscrm_JS_calcTotals()})}function zbscrm_JS_calculate_invoice_row_subtotals(){jQuery(".zbs-invoice-row").each(function(i,e){jQuery(e).children().find("input[type=number]").each(function(i,e){zbs_row_to_up=jQuery(this).data("zbsr"),jQuery(this).hasClass("quan")&&(quan=jQuery(this).val()),jQuery(this).hasClass("price")&&(price=jQuery(this).val())}),row_tot=quan*price,jQuery(".row-amount-"+zbs_row_to_up).html(row_tot.toFixed(zbs_root.currencyOptions.noOfDecimals)),zbscrm_JS_calculate_invoice_subtotal()})}function zbscrm_JS_calculate_invoice_subtotal(){var i=0;jQuery(".row-amount").each(function(e,t){var o=jQuery(this).html();""==o&&(o=0),o=parseFloat(o),i+=o}),jQuery("#subtotal-value").html(i.toFixed(zbs_root.currencyOptions.noOfDecimals))}function zbscrm_JS_calculate_invoice_tax_table(){var i=[],e=[],t=[],o=0,n=-1,a=-1;jQuery(".tax-select").each(function(s,c){if(n=jQuery(this).val(),-1==(a=jQuery(this).data("zbsr")))i[s]=jQuery(".zbsli_price"+a).val(),t[s]=1;else{var l=parseFloat(jQuery(".zbsli_quan"+a).val()),r=parseFloat(jQuery(".zbsli_price"+a).val());i[s]=l*r,t[s]=0}o+=i[s],n>0?(this_tax_line_data=zbscrm_JS_pickTaxRate(n),e[s]=this_tax_line_data.id):e[s]=0}),zbscrm_JS_calculate_tax_amounts(i,e,t)}function zbscrm_JS_pickTaxRate(i){var e=!1;return jQuery.each(window.zbs_invoice.tax_linesObj,function(t,o){void 0!==o.id&&o.id==i&&(e=o)}),e}function zbscrm_JS_calculate_tax_amounts(i,e,t){var o=parseFloat(jQuery("#discount-value").html());if(isNaN(o)&&(o=0),total=parseFloat(jQuery("#subtotal-value").html()),tax_amount=new Array,tax_id=new Array,tax_rate=new Array,total>0){discount_proportion=o>0?o/total:0;for(c=0;c<i.length;c++)if(1==t[c]?discount_proportion=0:discount_proportion=o/total,i[c]>0)if(0==e[c])tax_amount[c]=0,tax_id[c]=0;else{var n=zbscrm_JS_pickTaxRate(e[c]),a=parseFloat(n.rate);tax_amount[c]=(1-discount_proportion)*i[c]*a/100,tax_id[c]=e[c]}else tax_amount[c]=0,tax_id[c]=e[c]}for(var s=new Object,c=0;c<i.length;c++)s[tax_id[c]]=0;for(c=0;c<i.length;c++)s[tax_id[c]]=s[tax_id[c]]+tax_amount[c];var l="";jQuery.each(s,function(i,e){if(i>0){var t=zbscrm_JS_pickTaxRate(i);l+='<div class="total-row row">',l+='<div class="tax-name third zlabel">'+t.name+"</div>",l+='<div class="tax-rate third ri">('+t.rate+"%)</div>",l+='<div class="tax-amt zbs-total-tax third ri">'+s[i].toFixed(zbs_root.currencyOptions.noOfDecimals)+"</div>",l+="</div>"}}),jQuery("#tax-total-block").html(l)}function zbscrm_JS_calc_grandtotal(){var i=0;i+=parseFloat(jQuery("#subtotal-value").html()),1==window.zbs_invoice.invoiceObj.settings.invdis&&(i-=parseFloat(jQuery("#discount-value").html())),1==window.zbs_invoice.invoiceObj.settings.invpandp&&(i+=parseFloat(jQuery("#invoice_postage_total").val())),1==window.zbs_invoice.invoiceObj.settings.invtax&&jQuery(".zbs-total-tax").each(function(e,t){var o=parseFloat(jQuery(this).html());isNaN(o)||(i+=o)}),jQuery("#zbs-inv-grand-total").html(i.toFixed(zbs_root.currencyOptions.noOfDecimals)),jQuery("#zbs-inv-grand-total-store").val(i.toFixed(zbs_root.currencyOptions.noOfDecimals)),zbscrm_JS_calc_amount_due()}function zbscrm_JS_calc_amount_due(){window.invoice_partial&&(amount_due=parseFloat(jQuery("#zbs-inv-grand-total").html()),jQuery(".partial-row").each(function(i,e){var t=jQuery(".zbs-partial-value",e).text(),o=1;-1!==t.indexOf("(")&&(t=t.replace("(","").replace(")",""),o=-1),t=parseFloat(t)*o,amount_due-=t}),jQuery("#inv-amount-due").html(amount_due.toFixed(zbs_root.currencyOptions.noOfDecimals)))}function zbscrm_JS_bind_change_actions(){jQuery("#invoice-customiser-type").change(function(){"hours"==jQuery(this).val()?(jQuery("#zbs_inv_qoh").html("Hours"),jQuery("#zbs_inv_por").html("Rate")):(jQuery("#zbs_inv_qoh").html("Quantity"),jQuery("#zbs_inv_por").html("Price"))}),jQuery("#invoice_postage_total").change(function(){jQuery("#pandptotal").html(window.zbs_root.currencyOptions.currencyStr+parseFloat(jQuery(this).val()).toFixed(zbs_root.currencyOptions.noOfDecimals)),zbscrm_JS_calcTotals()}),jQuery("#invoice_discount_total, #invoice_discount_type").change(function(){zbscrm_JS_calcTotals()}),jQuery("#invoice_postage_tax").on("keyup mouseup",function(){""!=jQuery(this).val()&&zbscrm_JS_calcTotals()})}function zbscrm_JS_calculatediscount(){var i=jQuery("#invoice_discount_total").val(),e=jQuery("#invoice_discount_type").val();if(""!=i)if("m"==e)jQuery("#invoice_discount_total_value").val(parseFloat(i).toFixed(zbs_root.currencyOptions.noOfDecimals)),jQuery("#discount-value").html(parseFloat(i).toFixed(zbs_root.currencyOptions.noOfDecimals));else{var t=parseFloat(jQuery("#subtotal-value").html())*i/100;jQuery("#invoice_discount_total_value").val(parseFloat(t).toFixed(zbs_root.currencyOptions.noOfDecimals)),jQuery("#discount-value").html(parseFloat(t).toFixed(zbs_root.currencyOptions.noOfDecimals))}}function zbscrm_JS_invoice_typeahead_bind(){endpoint=wpApiSettings.root+"zbscrm/v1/concom?_wpnonce="+wpApiSettings.nonce;var i=new Bloodhound({datumTokenizer:function(i){return Bloodhound.tokenizers.whitespace(i.name_email)},queryTokenizer:Bloodhound.tokenizers.whitespace,prefetch:{url:endpoint,ttl:3e5,ajax:{type:"POST",cache:!1,data:{id:-1,obj_type:-1},complete:function(e,t){i.clearRemoteCache()}}},remote:{url:wpApiSettings.root+"zbscrm/v1/concom?_wpnonce="+wpApiSettings.nonce+"&s=%QUERY",wildcard:"%QUERY"}});i.initialize(),jQuery("#billing-to .typeahead").typeahead({minLength:1,highlight:!0,hint:!0},{name:"meslekler",displayKey:"name_email",display:"email",source:i.ttAdapter(),limit:5,templates:{suggestion:function(i){ico='<i class="user icon"></i>',2==i.obj_type&&(ico='<i class="building icon"></i>');var e=zbscrm_JS_invoice_lang("noname");void 0!==i.name&&(e=i.name);var t="&nbsp;";return void 0!==i.email&&(t=i.email),sug='<div class="sug-wrap"><div class="ico">'+ico+'</div><div class="inner"><div class="name">'+e+'</div><div class="email">'+t+'</div></div><div class="clear"</div></div>',sug},empty:function(i){var e='<a href="'+window.zbs_invoice.invoiceObj.settings.addnewcontacturl+'" target="_blank">'+zbscrm_JS_invoice_lang("addnewcontact")+"</a>";return window.zbs_invoice.invoiceObj.settings.b2bmode&&(e+=" "+zbscrm_JS_invoice_lang("or")+" ",e+='<a href="'+window.zbs_invoice.invoiceObj.settings.addnewcompanyurl+'" target="_blank">'+zbscrm_JS_invoice_lang("newcompany")+"</a>"),'<div class="zbs-add-new-js-assign-to"><i class="address book icon"></i>  '+e+"</div>"}}}).on("typeahead:selected",function(i,e,t){if(jQuery("#zbs_invoicing_send_email").hide(),void 0!==e.id&&null!==e.id&&""!==e.id){var o=zbscrmJS_retrieveCurrentBillToEmail();void 0!==o&&""!=o&&zbscrm_JS_validateEmail(o)&&jQuery("#zbs_invoicing_send_email").show()}1==e.obj_type?(jQuery("#zbs_invoice_contact").val(e.id),jQuery("#zbs_invoice_company").val(-1),zeroBSCRMJS_showContactLinkIf(e.id),zeroBSCRMJS_showCompanyLinkIf(-1)):2==e.obj_type&&(jQuery("#zbs_invoice_company").val(e.id),jQuery("#zbs_invoice_contact").val(-1),zeroBSCRMJS_showContactLinkIf(-1),zeroBSCRMJS_showCompanyLinkIf(e.id))}).on("typeahead:change",function(i,e,t){if(jQuery("#zbs_invoicing_send_email").hide(),void 0!==e.id&&null!==e.id&&""!==e.id){var o=zbscrmJS_retrieveCurrentBillToEmail();void 0!==o&&""!=o&&zbscrm_JS_validateEmail(o)&&jQuery("#zbs_invoicing_send_email").show()}}),setTimeout(function(){var i=(new Date).getTime();if(void 0===(e=jQuery("#billing-to .typeahead").attr("data-autokey")))var e="-typeahead";var t="zbsobj-"+i+"-"+e;jQuery("#billing-to .typeahead").attr("autocomplete",t).attr("name",t)},0),jQuery(this).on("typeahead:open",function(i,e){var t=(new Date).getTime();if(void 0===(o=jQuery("#billing-to .typeahead").attr("data-autokey")))var o="-typeahead";var n="zbsobj-"+t+"-"+o;jQuery("#billing-to .typeahead").attr("autocomplete",n).attr("name",n)})}function zbscrm_JS_bindInitialLearnLinks(){if(void 0!==window.zbs_invoice.invoiceObj&&void 0!==window.zbs_invoice.invoiceObj.invoice_contact&&"0"!=window.zbs_invoice.invoiceObj.invoice_contact&&"-1"!=window.zbs_invoice.invoiceObj.invoice_contact){var i=parseInt(window.zbs_invoice.invoiceObj.invoice_contact);i>0&&zeroBSCRMJS_showContactLinkIf(i)}if(void 0!==window.zbs_invoice.invoiceObj&&void 0!==window.zbs_invoice.invoiceObj.invoice_company&&"0"!=window.zbs_invoice.invoiceObj.invoice_company&&"-1"!=window.zbs_invoice.invoiceObj.invoice_company){var e=parseInt(window.zbs_invoice.invoiceObj.invoice_company);e>0&&zeroBSCRMJS_showCompanyLinkIf(e)}}function zeroBSCRMJS_showContactLinkIf(i){if(jQuery("#zbs-invoice-learn-nav .zbs-invoice-quicknav-contact").remove(),void 0!==i&&null!==i&&""!==i&&(i=parseInt(i))>0){var e='<a target="_blank" style="margin-left:6px;" class="zbs-invoice-quicknav-contact ui icon button blue mini labeled" href="'+window.zbs_invoice.invoiceObj.settings.contacturlprefix+i+'"><i class="user icon"></i> '+zbscrm_JS_invoice_lang("contact")+"</a>";jQuery("#zbs-invoice-learn-nav").prepend(e)}}function zeroBSCRMJS_showCompanyLinkIf(i){if(jQuery("#zbs-invoice-learn-nav .zbs-invoice-quicknav-company").remove(),void 0!==i&&null!==i&&""!==i&&(i=parseInt(i))>0){var e='<a target="_blank" style="margin-left:6px;" class="zbs-invoice-quicknav-company ui icon button blue mini labeled" href="'+window.zbs_invoice.invoiceObj.settings.companyurlprefix+i+'"><i class="building icon"></i> '+zbscrm_JS_invoice_lang("company")+"</a>";jQuery("#zbs-invoice-learn-nav").prepend(e)}}function zbscrm_JS_bind_invoice_actions(){jQuery(".zbs-add-memo-trigger").off("click").on("click",function(i){jQuery(".zbs-memo-box").show(),jQuery(".zbs-add-memo-trigger").hide()}),jQuery(".zbs-memo-hide").off("click").on("click",function(i){jQuery(".zbs-memo-box").hide(),jQuery(".zbs-add-memo-trigger").show()}),jQuery(".wh-logo-set .zbs-remove").off("click").on("click",function(i){jQuery("#wh-logo-set-img").attr("src","").hide(),jQuery("#zbs_invoice_logo").val(""),jQuery(".wh-logo").removeClass("hide").show(),jQuery(".wh-logo-set").hide()}),jQuery(".business-info-toggle").off("click").on("click",function(i){i.preventDefault(),jQuery(".business-info-toggle i").hasClass("fa-chevron-circle-right")?(jQuery(".business-info-toggle i").removeClass("fa-chevron-circle-right").addClass("fa-chevron-circle-down"),jQuery(".business-info").show()):(jQuery(".business-info-toggle i").removeClass("fa-chevron-circle-down").addClass("fa-chevron-circle-right"),jQuery(".business-info").hide())}),jQuery(".wh-logo, .wh-logo-set .zbs-update").off("click").on("click",function(i){var e;i.preventDefault(),formlabel=jQuery(this).parent(),e?e.open():((e=wp.media.frames.zbs_media_frame=wp.media({className:"media-frame zbs-media-frame",frame:"select",multiple:!1,library:{type:"image"}})).on("select",function(){var i=e.state().get("selection").first().toJSON();jQuery("#logo").val(i.url),jQuery("#wh-logo-set-img").attr("src",i.url).show(),jQuery(".wh-logo-set").show(),jQuery(".wh-logo").hide()}),e.open())}),jQuery("#zbs_invoicing_download_pdf").off("click").on("click",function(i){i.preventDefault(),jQuery("#zbs_invoicing_download_pdf_form").submit()}),zbscrm_JS_bind_due_days(),zbscrm_JS_bindDateRangePicker(),zbscrm_JS_invoice_typeahead_bind(),zbscrm_JS_bindInitialLearnLinks(),zbscrm_JS_calculate_invoice_row_subtotals(),zbscrm_JS_calcTotals(),jQuery("#zbs_invoicing_send_email").off("click").click(function(i,e){zbscrmJS_sendInvoiceModal()})}function zbscrmJS_sendInvoiceModal(){var i="",e=zbscrmJS_retrieveCurrentBillToEmail();if(void 0!==e&&""!=e&&zbscrm_JS_validateEmail(e)&&(i=e),void 0!==i&&""!=i&&zbscrm_JS_validateEmail(i)){var t='<div id="zbs_invoice_email_modal_opts">';if(t+='<div class="zbs-invoice-email-modal-field">',t+='<label for="zbs_invoice_email_modal_toemail">'+zbscrm_JS_invoice_lang("toemail")+"</label>",t+='<input type="email" id="zbs_invoice_email_modal_toemail" value="'+i+'" placeholder="'+zbscrm_JS_invoice_lang("toemailplaceholder")+'" />',t+="</div>",jQuery(".zbsFileLine").length>0){t+='<div class="zbs-invoice-email-modal-field">';o="";jQuery("#zbsc_sendattachments").is(":checked")&&(o='checked="checked" '),t+='<input type="checkbox" id="zbs_invoice_email_modal_attachassoc" value="1" '+o+"/>",t+='<label for="zbs_invoice_email_modal_attachassoc">'+zbscrm_JS_invoice_lang("attachassoc")+"</label>",t+="</div>"}var o;t+='<div class="zbs-invoice-email-modal-field">',t+='<input type="checkbox" id="zbs_invoice_email_modal_attachaspdf" value="1" '+(o='checked="checked" ')+"/>",t+='<label for="zbs_invoice_email_modal_attachaspdf">'+zbscrm_JS_invoice_lang("attachpdf")+"</label>",t+="</div>",t+="</div>",swal({title:zbscrm_JS_invoice_lang("send_email"),html:'<div class="ui segment">'+zbscrm_JS_invoice_lang("sendthisemail")+t+"</div>",type:"question",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:zbscrm_JS_invoice_lang("sendthemail")}).then(function(i){if(i.value){var e=jQuery("#zbs_invoice_email_modal_toemail").val();if(void 0!==e&&""!=e&&zbscrm_JS_validateEmail(e)&&window.invoice_id>0){var t=-1;jQuery("#zbs_invoice_email_modal_attachassoc").length>0&&jQuery("#zbs_invoice_email_modal_attachassoc").is(":checked")&&(t=1);var o=-1;jQuery("#zbs_invoice_email_modal_attachaspdf").length>0&&jQuery("#zbs_invoice_email_modal_attachaspdf").is(":checked")&&(o=1);var n={id:window.invoice_id,email:e,attachassoc:t,attachpdf:o};swal.fire({title:zbscrm_JS_invoice_lang("sendingemail"),html:'<div style="clear:both">&nbsp;</div><div class="ui active loader" style="margin-top:2em;padding-bottom:2em"></div><div style="clear:both">&nbsp;</div>',showConfirmButton:!1,showCancelButton:!1,allowOutsideClick:!1}),zbscrmJS_sendInvoiceEmail(n)}else swal.fire(zbscrm_JS_invoice_lang("sendneedsassignment"))}})}else swal.fire(zbscrm_JS_invoice_lang("sendneedsassignment"))}function zbscrmJS_sendInvoiceEmail(i){window.zbsInvBlocker||(window.zbsInvBlocker=!0,void 0!==i.id&&i.id>0&&void 0!==i.email&&zbscrm_JS_validateEmail(i.email)&&(i.action="zbs_invoice_send_invoice",i.security=jQuery("#inv-ajax-nonce").val(),jQuery.ajax({url:ajaxurl,type:"POST",data:i,dataType:"json",success:function(i){console.log("sent",i),swal(zbscrm_JS_invoice_lang("senttitle"),zbscrm_JS_invoice_lang("sent"),"info"),window.zbsInvBlocker=!1},error:function(i){console.error("senderr",i),swal(zbscrm_JS_invoice_lang("senderrortitle")+" #19v3",zbscrm_JS_invoice_lang("senderror"),"error"),window.zbsInvBlocker=!1}})))}function zbscrm_JS_transaction_edit_URL(i){return zbscrm_JS_DAL()>2?zeroBSCRMJS_obj_editLink("transaction",i):(zbs_admin_url=window.zbs_links.admin_url,zbs_transaction_link=zbs_admin_url+"post.php?action=edit&post="+i,zbs_transaction_link)}function zeroBSCRMJS_invEditLang(i){return void 0!==window.zbsInvoiceBuilderLang[i]?window.zbsInvoiceBuilderLang[i]:""}function zbscrm_JS_calcTotals(){zbscrm_JS_calculate_invoice_subtotal(),zbscrm_JS_calculatediscount(),zbscrm_JS_calculate_invoice_tax_table(),zbscrm_JS_calc_grandtotal()}function zbscrm_JS_invoice_lang(i,e,t){if(void 0===e)e="";if(void 0!==window.zbs_invoice.invoiceObj.settings.lang[i]){if(void 0===t)return window.zbs_invoice.invoiceObj.settings.lang[i];if(void 0!==window.zbs_invoice.invoiceObj.settings.lang[i][t])return window.zbs_invoice.invoiceObj.settings.lang[i][t]}return e}var zbs_invoice=!1,zbs_tax=!1,zbs_tax_table=!1,zbsInvBlocker=!1;jQuery(document).ready(function(){jQuery(".handlediv").remove(),jQuery(".ui-sortable-handle").remove(),jQuery(".hndle").css("cursor","default"),invoice_id=jQuery(".zbs_invoice_html_canvas").data("invid"),zbscrm_JS_retrieve_invoice_data(invoice_id),jQuery("#invoice_tax_total").val()>0&&jQuery("#invoice_totals .tax_total").show()});